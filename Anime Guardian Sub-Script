local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

local Window = Rayfield:CreateWindow({
   Name = "Anime Guardian Sub-Script",
   LoadingTitle = "Show Hub",
   LoadingSubtitle = "Made by Kero :333",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = "AnimeGuardianSub_V4",
      FileName = "KeroConfig"
   },
   KeySystem = false,
})

-- =============================================
-- VARIABLES & SERVICES
-- =============================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

-- Lobby Variables
local selectedStage = "City of Shattered Frost" 
local isFriendOnly = true
local isAutoHosting = false

-- Restart Variables
local targetCoins = 0
local targetWave = 0
local isAutoRestart = false

-- Modifier Variables
local isAutoBuy = false
local prioritySlot1 = "Golden Tribute"
local prioritySlot2 = "Power Surge"
local prioritySlot3 = "Saiya"
local prioritySlot4 = "Time Snare"

-- Defaults
local modifierList = {"None", "Golden Tribute", "Power Surge", "Saiya", "Time Snare"}
local defaultStages = {"City of Shattered Frost", "Priestella", "Roswaal Mansion"}

-- =============================================
-- HELPER FUNCTIONS
-- =============================================

local function getAvailableStages()
    local list = {}
    local stagesFolder = LocalPlayer:WaitForChild("Stages", 3) 
    if stagesFolder then
        for _, stageObj in ipairs(stagesFolder:GetChildren()) do
            table.insert(list, stageObj.Name)
        end
    end
    if #list == 0 then return defaultStages end
    table.sort(list)
    return list
end

local function cleanNumber(str)
    if not str then return 0 end
    local cleanStr = string.gsub(str, "%D", "") 
    return tonumber(cleanStr) or 0
end

local function getMyMoney()
    local mainGui = LocalPlayer.PlayerGui:FindFirstChild("Main")
    if mainGui then
        local unitBar = mainGui:FindFirstChild("UnitBar")
        if unitBar then
            local dataFrame = unitBar:FindFirstChild("DataFrame")
            if dataFrame then
                local coinsLabel = dataFrame:FindFirstChild("Coins")
                if coinsLabel then return cleanNumber(coinsLabel.Text) end
            end
        end
    end
    return 0
end

local function getModifierPrice(modName)
    local npcShop = LocalPlayer.PlayerGui:FindFirstChild("Npc_Shop")
    if npcShop then
        local modShop = npcShop:FindFirstChild("ModifierShop")
        if modShop then
            local inset = modShop:FindFirstChild("Inset")
            if inset then
                local scroll = inset:FindFirstChild("ScrollingFrame")
                if scroll then
                    local item = scroll:FindFirstChild(modName)
                    if item then
                        local priceLabel = item:FindFirstChild("PriceText")
                        if priceLabel then return cleanNumber(priceLabel.Text) end
                    end
                end
            end
        end
    end
    return 999999999 
end

local function getCurrentWave()
    if LocalPlayer.PlayerGui:FindFirstChild("GUI") 
       and LocalPlayer.PlayerGui.GUI:FindFirstChild("BaseFrame") 
       and LocalPlayer.PlayerGui.GUI.BaseFrame:FindFirstChild("Wave") then
        
        local waveText = LocalPlayer.PlayerGui.GUI.BaseFrame.Wave.Text
        return cleanNumber(waveText)
    end
    return 0
end

-- =============================================
-- TAB 1: LOBBY MANAGER
-- =============================================
local LobbyTab = Window:CreateTab("Lobby Manager", 4483362458)

LobbyTab:CreateSection("Room Settings")

local StageDropdown = LobbyTab:CreateDropdown({
   Name = "Select Stage",
   Options = getAvailableStages(), 
   CurrentOption = {defaultStages[1]},
   MultipleOptions = false,
   Flag = "Lobby_Stage",
   Callback = function(Option)
      selectedStage = Option[1]
   end,
})

LobbyTab:CreateButton({
   Name = "Refresh List",
   Callback = function()
       local newStages = getAvailableStages()
       StageDropdown:Refresh(newStages, true)
       Rayfield:Notify({Title = "Updated", Content = "Found " .. #newStages .. " stages.", Duration = 2})
   end,
})

LobbyTab:CreateToggle({
   Name = "Friend Only",
   CurrentValue = true,
   Flag = "Lobby_FriendOnly", 
   Callback = function(Value)
      isFriendOnly = Value
   end,
})

LobbyTab:CreateSection("Automation")

LobbyTab:CreateToggle({
   Name = "Auto Host",
   CurrentValue = false,
   Flag = "Lobby_AutoHost", 
   Callback = function(Value)
      isAutoHosting = Value
   end,
})

-- =============================================
-- TAB 2: IN-GAME MANAGER
-- =============================================
local GameTab = Window:CreateTab("In-Game Manager", 4483362458)

-- --- SECTION: MODIFIER SHOP ---
GameTab:CreateSection("Modifier Shop")

GameTab:CreateToggle({
   Name = "Auto Buy Modifiers",
   CurrentValue = false,
   Flag = "Shop_AutoBuy",
   Callback = function(Value)
      isAutoBuy = Value
   end,
})

GameTab:CreateLabel("Priority Order:")

GameTab:CreateDropdown({
   Name = "Priority 1",
   Options = modifierList,
   CurrentOption = {"Golden Tribute"},
   MultipleOptions = false,
   Flag = "Shop_Slot1",
   Callback = function(Option) prioritySlot1 = Option[1] end,
})

GameTab:CreateDropdown({
   Name = "Priority 2",
   Options = modifierList,
   CurrentOption = {"Power Surge"},
   MultipleOptions = false,
   Flag = "Shop_Slot2",
   Callback = function(Option) prioritySlot2 = Option[1] end,
})

GameTab:CreateDropdown({
   Name = "Priority 3",
   Options = modifierList,
   CurrentOption = {"Saiya"},
   MultipleOptions = false,
   Flag = "Shop_Slot3",
   Callback = function(Option) prioritySlot3 = Option[1] end,
})

GameTab:CreateDropdown({
   Name = "Priority 4",
   Options = modifierList,
   CurrentOption = {"Time Snare"},
   MultipleOptions = false,
   Flag = "Shop_Slot4",
   Callback = function(Option) prioritySlot4 = Option[1] end,
})

-- --- SECTION: AUTO RESTART ---
GameTab:CreateSection("Auto Restart")

GameTab:CreateToggle({
   Name = "Auto Restart",
   CurrentValue = false,
   Flag = "Restart_Master", 
   Callback = function(Value)
      isAutoRestart = Value
   end,
})

GameTab:CreateInput({
   Name = "Target Coins",
   PlaceholderText = "0 to disable",
   RemoveTextAfterFocusLost = false,
   Flag = "Restart_Coins", 
   Callback = function(Text)
       targetCoins = tonumber(Text) or 0
   end,
})

GameTab:CreateInput({
   Name = "Target Wave",
   PlaceholderText = "0 to disable",
   RemoveTextAfterFocusLost = false,
   Flag = "Restart_Wave", 
   Callback = function(Text)
       targetWave = tonumber(Text) or 0
   end,
})

local StatusLabel = GameTab:CreateLabel("Status: Waiting...")

-- =============================================
-- LOGIC LOOPS
-- =============================================

-- 1. Auto Host Loop
task.spawn(function()
    while true do
        if isAutoHosting then
            local RoomFunction = ReplicatedStorage:FindFirstChild("Remote") and ReplicatedStorage.Remote:FindFirstChild("RoomFunction")
            if RoomFunction then
                pcall(function()
                    local args = {
                        [1] = "host",
                        [2] = { ["stage"] = selectedStage, ["friendOnly"] = isFriendOnly }
                    }
                    RoomFunction:InvokeServer(unpack(args))
                    task.wait(1.5)
                    RoomFunction:InvokeServer("start")
                end)
                task.wait(3)
            end
        end
        task.wait(1)
    end
end)

-- 2. Auto Restart Loop (Coin OR Wave)
task.spawn(function()
    while true do
        local currentCoin = 0
        if LocalPlayer.PlayerGui:FindFirstChild("GUI") 
           and LocalPlayer.PlayerGui.GUI:FindFirstChild("BaseFrame") 
           and LocalPlayer.PlayerGui.GUI.BaseFrame:FindFirstChild("RewardFrame") 
           and LocalPlayer.PlayerGui.GUI.BaseFrame.RewardFrame:FindFirstChild("ChristmasCoin") then
            currentCoin = cleanNumber(LocalPlayer.PlayerGui.GUI.BaseFrame.RewardFrame.ChristmasCoin.Text)
        end
        
        local currentWave = getCurrentWave()
        
        StatusLabel:Set("Coin: " .. currentCoin .. " / " .. targetCoins .. " | Wave: " .. currentWave .. " / " .. targetWave)

        if isAutoRestart then
            local MiscAction = ReplicatedStorage:FindFirstChild("Remotes") 
                               and ReplicatedStorage.Remotes:FindFirstChild("Misc") 
                               and ReplicatedStorage.Remotes.Misc:FindFirstChild("Action")

            if MiscAction then
                local shouldRestart = false
                
                if targetCoins > 0 and currentCoin >= targetCoins then
                    Rayfield:Notify({Title = "Restarting", Content = "Target Coins Reached!", Duration = 3})
                    shouldRestart = true
                end
                
                if targetWave > 0 and currentWave >= targetWave then
                    Rayfield:Notify({Title = "Restarting", Content = "Target Wave Reached!", Duration = 3})
                    shouldRestart = true
                end

                if shouldRestart then
                    pcall(function() MiscAction:FireServer("Restart") end)
                    task.wait(10)
                end
            end
        end
        task.wait(0.5)
    end
end)

-- 3. Auto Buy Modifier Loop
task.spawn(function()
    while true do
        if isAutoBuy then
            local myMoney = getMyMoney()
            local ModifierShop = ReplicatedStorage:FindFirstChild("ModifierShop")
            local currentQueue = {prioritySlot1, prioritySlot2, prioritySlot3, prioritySlot4}

            if ModifierShop then
                for _, modName in ipairs(currentQueue) do
                    if modName and modName ~= "None" then
                        local price = getModifierPrice(modName)
                        if myMoney >= price then
                            pcall(function()
                                ModifierShop:InvokeServer(modName)
                                myMoney = myMoney - price 
                            end)
                            task.wait(0.2)
                        end
                    end
                end
            end
        end
        task.wait(0.5)
    end
end)

Rayfield:LoadConfiguration()
