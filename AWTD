-- [V39] AWTD Macro | Lobby Manager & Auto-Save
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua"))()
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local GuiService = game:GetService("GuiService")

local Window = Fluent:CreateWindow({
    Title = "AWTD",
    SubTitle = "Made By Kero:33",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true, 
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightControl
})

-- =============================================
-- CONFIGURATION
-- =============================================
local RETRY_X = 650
local RETRY_Y = 468
local MACRO_FOLDER = "AWTD_Macros_Kero"
local CALC_DELAY = 0.5 

-- =============================================
-- VARIABLES
-- =============================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local isRecording = false
local isPlaying = false
local isLooping = false 
local currentMacroData = {} 
local currentMacroName = "" 
local startTime = 0
local playbackMode = "Hybrid" 

local AllowedRemotes = {
    ["SpawnUnit"] = true, ["SellUnit"] = true, ["UpgradeUnit"] = true,
    ["UnitAbility"] = true, ["BuyMeat"] = true, ["FeedAll"] = true,
    ["SkipEvent"] = true, ["x2Event"] = true
}

if not isfolder(MACRO_FOLDER) then makefolder(MACRO_FOLDER) end

-- =============================================
-- HELPER FUNCTIONS
-- =============================================
local function SmartFire(remote, args)
    if not remote then return end
    args = args or {}
    if remote:IsA("RemoteEvent") or remote:IsA("UnreliableRemoteEvent") then
        remote:FireServer(unpack(args))
    elseif remote:IsA("RemoteFunction") then
        task.spawn(function() pcall(function() remote:InvokeServer(unpack(args)) end) end)
    end
end

local function CFrameToTable(cf) return {cf:GetComponents()} end
local function TableToCFrame(tab) return CFrame.new(unpack(tab)) end

local function getCash()
    local ls = LocalPlayer:FindFirstChild("leaderstats")
    return (ls and ls:FindFirstChild("Cash")) and ls.Cash.Value or 0
end

local function findUnitByCFrame(targetCFrame)
    if not Workspace:FindFirstChild("Units") then return nil end
    for _, unit in pairs(Workspace.Units:GetChildren()) do
        local root = unit:FindFirstChild("HumanoidRootPart") or unit.PrimaryPart
        if root and (root.Position - targetCFrame.Position).Magnitude < 1.5 then return unit end
    end
    return nil
end

-- =============================================
-- FILE SYSTEM
-- =============================================
local function SaveCurrentMacro()
    if currentMacroName == "" then return end
    local exportData = {}
    for _, act in ipairs(currentMacroData) do
        local entry = table.clone(act)
        if entry.CFrame then entry.CFrame = CFrameToTable(entry.CFrame) end
        table.insert(exportData, entry)
    end
    writefile(MACRO_FOLDER.."/"..currentMacroName..".json", HttpService:JSONEncode(exportData))
    Fluent:Notify({Title="System", Content="Saved: "..currentMacroName, Duration=2})
end

local function LoadMacro(name)
    if not isfile(MACRO_FOLDER.."/"..name..".json") then return end
    local content = readfile(MACRO_FOLDER.."/"..name..".json")
    local decoded = HttpService:JSONDecode(content)
    currentMacroData = {}
    for _, act in ipairs(decoded) do
        if act.CFrame then act.CFrame = TableToCFrame(act.CFrame) end
        table.insert(currentMacroData, act)
    end
    currentMacroName = name
end

local function GetMacroFiles()
    local files = listfiles(MACRO_FOLDER)
    local names = {}
    for _, file in ipairs(files) do
        local name = file:match("([^/]+)%.json$")
        if name then table.insert(names, name) end
    end
    return names
end

-- =============================================
-- RECORDER
-- =============================================
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    if checkcaller() then return oldNamecall(self, ...) end
    if not isRecording then return oldNamecall(self, ...) end
    local method = getnamecallmethod()
    if (method == "InvokeServer" or method == "FireServer") and AllowedRemotes[self.Name] then
        local rName = self.Name
        local args = {...}
        task.spawn(function()
            pcall(function()
                local currentTime = tick() - startTime
                local preCash = getCash()

                if rName == "SpawnUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    table.insert(currentMacroData, {Action="Place", Time=currentTime, Cost=realCost, UnitName=args[1], CFrame=args[2], Slot=args[3], Data=args[4]})
                    Fluent:Notify({Title="Rec", Content="Place", Duration=1})
                elseif rName == "SellUnit" then
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Sell", Time=currentTime, Cost=0, CFrame=u.PrimaryPart.CFrame}); Fluent:Notify({Title="Rec", Content="Sell", Duration=1}) end
                elseif rName == "UpgradeUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Upgrade", Time=currentTime, Cost=realCost, CFrame=u.PrimaryPart.CFrame}); Fluent:Notify({Title="Rec", Content="Upgrade", Duration=1}) end
                elseif rName == "UnitAbility" then
                     local u = args[2]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Ability", Time=currentTime, Cost=0, SkillName=args[1], CFrame=u.PrimaryPart.CFrame}) end
                elseif rName == "BuyMeat" then 
                    task.wait(CALC_DELAY)
                    table.insert(currentMacroData, {Action="BuyMeat", Time=currentTime, Cost=math.max(0, preCash - getCash()), Args=args})
                    Fluent:Notify({Title="Rec", Content="Buy Meat", Duration=1})
                elseif rName == "FeedAll" then table.insert(currentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- UI SETUP
-- =============================================
local Tabs = {
    Macro = Window:AddTab({ Title = "Macro Manager", Icon = "file-cog" }),
    Lobby = Window:AddTab({ Title = "Lobby Manager", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}
local Options = Fluent.Options
local StatusParagraph = Tabs.Macro:AddParagraph({ Title = "Status: Idle", Content = "Waiting..." })

local function UpdateStatus(status, details)
    StatusParagraph:SetTitle("Status: " .. status)
    StatusParagraph:SetDesc(details or "")
end

-- TAB: MACRO MANAGER
Tabs.Macro:AddInput("InputMacroName", {Title = "New Macro Name", Placeholder = "MapName_Diff", Callback = function() end})
Tabs.Macro:AddButton({Title = "Create New File", Callback = function() local name = Options.InputMacroName.Value; if name~="" then currentMacroName=name; currentMacroData={}; SaveCurrentMacro(); Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(name) end end})
Tabs.Macro:AddDropdown("FileSelect", {Title = "Select File", Values = GetMacroFiles(), Default = 1, Callback = function(v) if v then LoadMacro(v) end end})
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); Options.FileSelect:SetValue(f[1]) end end)
Tabs.Macro:AddButton({Title = "Refresh / Delete", Callback = function() if currentMacroName~="" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then delfile(MACRO_FOLDER.."/"..currentMacroName..".json"); currentMacroName=""; currentMacroData={}; Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(nil) else Options.FileSelect:SetValues(GetMacroFiles()) end end})

Tabs.Macro:AddToggle("RecordToggle", {Title = "Record", Default = false }):OnChanged(function(v)
    if v then isPlaying=false; isRecording=true; currentMacroData={}; startTime=tick(); UpdateStatus("Recording", "Started...")
    else isRecording=false; SaveCurrentMacro(); UpdateStatus("Stopped", "Saved.") end
end)

Tabs.Macro:AddDropdown("ModeSelect", {Title = "Mode", Values = {"Time", "Money", "Hybrid"}, Default = "Hybrid", Callback = function(v) playbackMode = v end})

Tabs.Macro:AddToggle("PlayToggle", {Title = "Play", Default = false }):OnChanged(function(v)
    if v then isRecording=false; playMacro() else isPlaying=false; UpdateStatus("Stopped", "User Cancelled") end
end)

-- TAB: LOBBY MANAGER
Tabs.Lobby:AddParagraph({Title = "Auto Restart", Content = "Uses fixed coordinates ("..RETRY_X..", "..RETRY_Y..")"})
local LoopToggle = Tabs.Lobby:AddToggle("LoopToggle", {Title = "Auto Restart", Default = false })
LoopToggle:OnChanged(function(v) isLooping = v end)

-- TAB: SETTINGS & AUTO SAVE
SaveManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
SaveManager:BuildConfigSection(Tabs.Settings)

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)

Window:SelectTab(1)

-- Auto Load Config
SaveManager:LoadAutoloadConfig()

-- =============================================
-- LOGIC
-- =============================================
local function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

local function PerformRestartSequence()
    UpdateStatus("Looping", "Effect Found! Waiting 2s...")
    task.wait(2)
    UpdateStatus("Looping", "Clicking Retry ("..RETRY_X..", "..RETRY_Y..")...")
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, true, game, 1)
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, false, game, 1)
    UpdateStatus("Looping", "Clicked. Waiting 5s for reload...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                if isLooping and CheckForEndGame() then matchEnded = true; break end
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = true
                    if playbackMode ~= "Time" and cost > 0 then readyM = cash >= cost end
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         elseif not readyM then UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; Options.PlayToggle:SetValue(false); UpdateStatus("Stopped", "Finished Run"); break end
            end
        end
    end)
end
