-- [V41] AWTD Macro | MacLib UI | Smart Restart
-- Copy toàn bộ đoạn script này dán vào Executor
local MacLib = loadstring(game:HttpGet("https://github.com/shlexware/MacLib/releases/latest/download/main.lua"))()

local Window = MacLib:Window({
    Title = "AWTD Macro",
    Subtitle = "Smart Restart (No Coords)",
    Size = UDim2.fromOffset(550, 400),
    DragStyle = 1,
    Theme = "Dark"
})

-- =============================================
-- SERVICES
-- =============================================
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local GuiService = game:GetService("GuiService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- =============================================
-- CONFIG
-- =============================================
local MACRO_FOLDER = "AWTD_Macros_Kero"
local CALC_DELAY = 0.5 

-- =============================================
-- VARIABLES
-- =============================================
local isRecording = false
local isPlaying = false
local isLooping = false 
local currentMacroData = {} 
local currentMacroName = "" 
local inputMacroNameVal = "" 
local startTime = 0
local playbackMode = "Hybrid" 

local AllowedRemotes = {
    ["SpawnUnit"] = true, ["SellUnit"] = true, ["UpgradeUnit"] = true,
    ["UnitAbility"] = true, ["BuyMeat"] = true, ["FeedAll"] = true,
    ["SkipEvent"] = true, ["x2Event"] = true
}

if not isfolder(MACRO_FOLDER) then makefolder(MACRO_FOLDER) end

-- =============================================
-- UI TABS
-- =============================================
local TabMacro = Window:Tab("Macro Manager")
local TabLobby = Window:Tab("Lobby Manager")

local GroupFile = TabMacro:Group("File System")
local GroupRec = TabMacro:Group("Recorder & Player")
local GroupInfo = TabMacro:Group("Status")
local GroupLobby = TabLobby:Group("Auto Restart")

-- =============================================
-- HELPERS
-- =============================================
local function Notify(title, content)
    Window:Notify({ Title = title, Description = content, Lifetime = 3 })
end

local function SmartFire(remote, args)
    if not remote then return end
    args = args or {}
    if remote:IsA("RemoteEvent") or remote:IsA("UnreliableRemoteEvent") then
        remote:FireServer(unpack(args))
    elseif remote:IsA("RemoteFunction") then
        task.spawn(function() pcall(function() remote:InvokeServer(unpack(args)) end) end)
    end
end

local function CFrameToTable(cf) return {cf:GetComponents()} end
local function TableToCFrame(tab) return CFrame.new(unpack(tab)) end

local function getCash()
    local ls = LocalPlayer:FindFirstChild("leaderstats")
    return (ls and ls:FindFirstChild("Cash")) and ls.Cash.Value or 0
end

local function findUnitByCFrame(targetCFrame)
    if not Workspace:FindFirstChild("Units") then return nil end
    for _, unit in pairs(Workspace.Units:GetChildren()) do
        local root = unit:FindFirstChild("HumanoidRootPart") or unit.PrimaryPart
        if root and (root.Position - targetCFrame.Position).Magnitude < 1.5 then return unit end
    end
    return nil
end

local function GetMacroFiles()
    local files = listfiles(MACRO_FOLDER)
    local names = {}
    for _, file in ipairs(files) do
        local name = file:match("([^/]+)%.json$")
        if name then table.insert(names, name) end
    end
    return names
end

-- =============================================
-- UI COMPONENTS
-- =============================================
local StatusLabel = GroupInfo:Label("Status: Idle")

local function UpdateStatus(status, details)
    StatusLabel:SetText("Status: " .. status .. " [" .. (details or "") .. "]")
end

GroupFile:Input("New Macro Name", {
    Default = "",
    Placeholder = "MapName_Diff",
    Callback = function(v) inputMacroNameVal = v end
})

local function SaveCurrentMacro()
    if currentMacroName == "" then return end
    local exportData = {}
    for _, act in ipairs(currentMacroData) do
        local entry = table.clone(act)
        if entry.CFrame then entry.CFrame = CFrameToTable(entry.CFrame) end
        table.insert(exportData, entry)
    end
    writefile(MACRO_FOLDER.."/"..currentMacroName..".json", HttpService:JSONEncode(exportData))
    Notify("System", "Saved: "..currentMacroName)
end

local function LoadMacro(name)
    if not isfile(MACRO_FOLDER.."/"..name..".json") then return end
    local content = readfile(MACRO_FOLDER.."/"..name..".json")
    local decoded = HttpService:JSONDecode(content)
    currentMacroData = {}
    for _, act in ipairs(decoded) do
        if act.CFrame then act.CFrame = TableToCFrame(act.CFrame) end
        table.insert(currentMacroData, act)
    end
    currentMacroName = name
    Notify("System", "Loaded: "..name)
end

local FileDropdown = GroupFile:Dropdown("Select File", {
    Options = GetMacroFiles(),
    Default = "...",
    Callback = function(v) if v then LoadMacro(v) end end
})

GroupFile:Button("Create New File", function()
    local name = inputMacroNameVal
    if name ~= "" then
        currentMacroName = name
        currentMacroData = {}
        SaveCurrentMacro()
        FileDropdown:SetOptions(GetMacroFiles())
        Notify("System", "Created: " .. name)
    else
        Notify("Error", "Enter a name first!")
    end
end)

GroupFile:Button("Refresh / Delete Selected", function()
    if currentMacroName ~= "" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then
        delfile(MACRO_FOLDER.."/"..currentMacroName..".json")
        Notify("System", "Deleted: " .. currentMacroName)
        currentMacroName = ""
        currentMacroData = {}
        FileDropdown:SetOptions(GetMacroFiles())
    else
        FileDropdown:SetOptions(GetMacroFiles())
        Notify("System", "Refreshed List")
    end
end)

GroupRec:Dropdown("Mode", {
    Options = {"Time", "Money", "Hybrid"},
    Default = "Hybrid",
    Callback = function(v) playbackMode = v end
})

local RecordToggle = GroupRec:Toggle("Record", {
    Default = false,
    Callback = function(v)
        if v then 
            isPlaying = false; isRecording = true; currentMacroData = {}; startTime = tick()
            UpdateStatus("Recording", "Started...")
        else 
            isRecording = false; SaveCurrentMacro()
            UpdateStatus("Stopped", "Saved.")
        end
    end
})

local PlayToggle = GroupRec:Toggle("Play", {
    Default = false,
    Callback = function(v)
        if v then
            isRecording = false
            task.spawn(function() playMacro() end)
        else
            isPlaying = false
            UpdateStatus("Stopped", "User Cancelled")
        end
    end
})

GroupLobby:Toggle("Auto Restart (Loop)", {
    Default = false,
    Callback = function(v) isLooping = v end
})

-- =============================================
-- RECORDER LOGIC
-- =============================================
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    if checkcaller() then return oldNamecall(self, ...) end
    if not isRecording then return oldNamecall(self, ...) end
    
    local method = getnamecallmethod()
    if (method == "InvokeServer" or method == "FireServer") and AllowedRemotes[self.Name] then
        local rName = self.Name
        local args = {...}
        task.spawn(function()
            pcall(function()
                local currentTime = tick() - startTime
                local preCash = getCash()
                if rName == "SpawnUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    table.insert(currentMacroData, {Action="Place", Time=currentTime, Cost=realCost, UnitName=args[1], CFrame=args[2], Slot=args[3], Data=args[4]})
                    Notify("Rec", "Place Unit")
                elseif rName == "SellUnit" then
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Sell", Time=currentTime, Cost=0, CFrame=u.PrimaryPart.CFrame}); Notify("Rec", "Sell Unit") end
                elseif rName == "UpgradeUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Upgrade", Time=currentTime, Cost=realCost, CFrame=u.PrimaryPart.CFrame}); Notify("Rec", "Upgrade") end
                elseif rName == "UnitAbility" then
                     local u = args[2]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Ability", Time=currentTime, Cost=0, SkillName=args[1], CFrame=u.PrimaryPart.CFrame}) end
                elseif rName == "BuyMeat" then 
                    task.wait(CALC_DELAY)
                    table.insert(currentMacroData, {Action="BuyMeat", Time=currentTime, Cost=math.max(0, preCash - getCash()), Args=args}); Notify("Rec", "Buy Meat")
                elseif rName == "FeedAll" then table.insert(currentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- PLAY & RESTART LOGIC
-- =============================================
local function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

local function PerformRestartSequence()
    UpdateStatus("Looping", "End Game Detected...")
    
    local function firebutton()
        local success, Button = pcall(function()
            return LocalPlayer.PlayerGui.EndUI.UI.Stage_Grid.Frame.Restart.Button
        end)
        if not success or not Button then return end

        GuiService.GuiNavigationEnabled = true
        GuiService.SelectedObject = Button
        VirtualInputManager:SendKeyEvent(true, "Return", false, game)
        VirtualInputManager:SendKeyEvent(false, "Return", false, game)
        task.wait(0.05)
        GuiService.GuiNavigationEnabled = false
        GuiService.SelectedObject = nil
    end

    -- Loop click until Effect disappears (Game Restarted)
    while CheckForEndGame() do
        UpdateStatus("Looping", "Clicking Retry...")
        firebutton()
        task.wait(1)
    end

    UpdateStatus("Looping", "Restarting...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then Notify("Manager", "No Data!"); PlayToggle:Set(false); return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                if isLooping and CheckForEndGame() then matchEnded = true; break end
                
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = (playbackMode == "Time") or (cash >= cost)
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         else UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
                if not isPlaying then break end
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; PlayToggle:Set(false); UpdateStatus("Stopped", "Finished"); break end
            end
        end
    end)
end

-- Init
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); FileDropdown:SetOptions(f) end end)
   elseif rName == "UnitAbility" then
                     local u = args[2]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Ability", Time=currentTime, Cost=0, SkillName=args[1], CFrame=u.PrimaryPart.CFrame}) end
                elseif rName == "BuyMeat" then 
                    task.wait(CALC_DELAY)
                    table.insert(currentMacroData, {Action="BuyMeat", Time=currentTime, Cost=math.max(0, preCash - getCash()), Args=args})
                    Fluent:Notify({Title="Rec", Content="Buy Meat", Duration=1})
                elseif rName == "FeedAll" then table.insert(currentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- UI SETUP
-- =============================================
local Tabs = {
    Macro = Window:AddTab({ Title = "Macro Manager", Icon = "file-cog" }),
    Lobby = Window:AddTab({ Title = "Lobby Manager", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}
local Options = Fluent.Options
local StatusParagraph = Tabs.Macro:AddParagraph({ Title = "Status: Idle", Content = "Waiting..." })

local function UpdateStatus(status, details)
    StatusParagraph:SetTitle("Status: " .. status)
    StatusParagraph:SetDesc(details or "")
end

-- TAB: MACRO
Tabs.Macro:AddInput("InputMacroName", {Title = "New Macro Name", Placeholder = "MapName_Diff", Callback = function() end})
Tabs.Macro:AddButton({Title = "Create New File", Callback = function() local name = Options.InputMacroName.Value; if name~="" then currentMacroName=name; currentMacroData={}; SaveCurrentMacro(); Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(name) end end})
Tabs.Macro:AddDropdown("FileSelect", {Title = "Select File", Values = GetMacroFiles(), Default = 1, Callback = function(v) if v then LoadMacro(v) end end})
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); Options.FileSelect:SetValue(f[1]) end end)
Tabs.Macro:AddButton({Title = "Refresh / Delete", Callback = function() if currentMacroName~="" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then delfile(MACRO_FOLDER.."/"..currentMacroName..".json"); currentMacroName=""; currentMacroData={}; Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(nil) else Options.FileSelect:SetValues(GetMacroFiles()) end end})

Tabs.Macro:AddToggle("RecordToggle", {Title = "Record", Default = false }):OnChanged(function(v)
    if v then 
        isPlaying = false; Options.PlayToggle:SetValue(false)
        isRecording = true; currentMacroData = {}; startTime = tick(); UpdateStatus("Recording", "Started...")
    else 
        isRecording = false; SaveCurrentMacro(); UpdateStatus("Stopped", "Saved.") 
    end
end)

Tabs.Macro:AddDropdown("ModeSelect", {Title = "Mode", Values = {"Time", "Money", "Hybrid"}, Default = "Hybrid", Callback = function(v) playbackMode = v end})

Tabs.Macro:AddToggle("PlayToggle", {Title = "Play", Default = false }):OnChanged(function(v)
    if v then 
        isRecording = false; Options.RecordToggle:SetValue(false)
        playMacro() 
    else 
        isPlaying = false; UpdateStatus("Stopped", "User Cancelled") 
    end
end)

-- TAB: LOBBY
local LoopToggle = Tabs.Lobby:AddToggle("LoopToggle", {Title = "Auto Restart (Loop)", Default = false })
LoopToggle:OnChanged(function(v) isLooping = v end)

-- TAB: SETTINGS (Fixed Order)
SaveManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
SaveManager:BuildConfigSection(Tabs.Settings)

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()

-- =============================================
-- LOGIC
-- =============================================
function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

function PerformRestartSequence()
    UpdateStatus("Looping", "Effect Found! Waiting 2s...")
    task.wait(2)
    UpdateStatus("Looping", "Clicking Retry ("..RETRY_X..", "..RETRY_Y..")...")
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, true, game, 1)
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, false, game, 1)
    UpdateStatus("Looping", "Clicked. Waiting 5s for reload...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                if isRecording then isPlaying = false; break end
                if isLooping and CheckForEndGame() then matchEnded = true; break end
                
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = true
                    if playbackMode ~= "Time" and cost > 0 then readyM = cash >= cost end
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         elseif not readyM then UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; Options.PlayToggle:SetValue(false); UpdateStatus("Stopped", "Finished Run"); break end
            end
        end
    end)
end
art then table.insert(currentMacroData, {Action="Ability", Time=currentTime, Cost=0, SkillName=args[1], CFrame=u.PrimaryPart.CFrame}) end
                elseif rName == "BuyMeat" then 
                    task.wait(CALC_DELAY)
                    table.insert(currentMacroData, {Action="BuyMeat", Time=currentTime, Cost=math.max(0, preCash - getCash()), Args=args})
                    Fluent:Notify({Title="Rec", Content="Buy Meat", Duration=1})
                elseif rName == "FeedAll" then table.insert(currentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- UI SETUP
-- =============================================
local Tabs = {
    Macro = Window:AddTab({ Title = "Macro Manager", Icon = "file-cog" }),
    Lobby = Window:AddTab({ Title = "Lobby Manager", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}
local Options = Fluent.Options
local StatusParagraph = Tabs.Macro:AddParagraph({ Title = "Status: Idle", Content = "Waiting..." })

local function UpdateStatus(status, details)
    StatusParagraph:SetTitle("Status: " .. status)
    StatusParagraph:SetDesc(details or "")
end

-- TAB: MACRO
Tabs.Macro:AddInput("InputMacroName", {Title = "New Macro Name", Placeholder = "MapName_Diff", Callback = function() end})
Tabs.Macro:AddButton({Title = "Create New File", Callback = function() local name = Options.InputMacroName.Value; if name~="" then currentMacroName=name; currentMacroData={}; SaveCurrentMacro(); Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(name) end end})
Tabs.Macro:AddDropdown("FileSelect", {Title = "Select File", Values = GetMacroFiles(), Default = 1, Callback = function(v) if v then LoadMacro(v) end end})
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); Options.FileSelect:SetValue(f[1]) end end)
Tabs.Macro:AddButton({Title = "Refresh / Delete", Callback = function() if currentMacroName~="" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then delfile(MACRO_FOLDER.."/"..currentMacroName..".json"); currentMacroName=""; currentMacroData={}; Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(nil) else Options.FileSelect:SetValues(GetMacroFiles()) end end})

Tabs.Macro:AddToggle("RecordToggle", {Title = "Record", Default = false }):OnChanged(function(v)
    if v then 
        isPlaying = false; Options.PlayToggle:SetValue(false)
        isRecording = true; currentMacroData = {}; startTime = tick(); UpdateStatus("Recording", "Started...")
    else 
        isRecording = false; SaveCurrentMacro(); UpdateStatus("Stopped", "Saved.") 
    end
end)

Tabs.Macro:AddDropdown("ModeSelect", {Title = "Mode", Values = {"Time", "Money", "Hybrid"}, Default = "Hybrid", Callback = function(v) playbackMode = v end})

Tabs.Macro:AddToggle("PlayToggle", {Title = "Play", Default = false }):OnChanged(function(v)
    if v then 
        isRecording = false; Options.RecordToggle:SetValue(false)
        playMacro() 
    else 
        isPlaying = false; UpdateStatus("Stopped", "User Cancelled") 
    end
end)

-- TAB: LOBBY
local LoopToggle = Tabs.Lobby:AddToggle("LoopToggle", {Title = "Auto Restart (Loop)", Default = false })
LoopToggle:OnChanged(function(v) isLooping = v end)

-- TAB: SETTINGS (FIXED LOAD ORDER)
SaveManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
SaveManager:BuildConfigSection(Tabs.Settings)

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()

-- =============================================
-- LOGIC
-- =============================================
function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

function PerformRestartSequence()
    UpdateStatus("Looping", "Effect Found! Waiting 2s...")
    task.wait(2)
    UpdateStatus("Looping", "Clicking Retry ("..RETRY_X..", "..RETRY_Y..")...")
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, true, game, 1)
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, false, game, 1)
    UpdateStatus("Looping", "Clicked. Waiting 5s for reload...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                if isRecording then isPlaying = false; break end
                if isLooping and CheckForEndGame() then matchEnded = true; break end
                
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = true
                    if playbackMode ~= "Time" and cost > 0 then readyM = cash >= cost end
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         elseif not readyM then UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; Options.PlayToggle:SetValue(false); UpdateStatus("Stopped", "Finished Run"); break end
            end
        end
    end)
end
    Button.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    Button.BackgroundTransparency = 0.2
    Button.Position = UDim2.new(0, 60, 0, 60) -- Vị trí mặc định
    Button.Size = UDim2.new(0, 45, 0, 45)
    -- [FIX] Icon Menu chuẩn (Hình 3 gạch ngang)
    Button.Image = "rbxassetid://10709782497" 
    Button.ImageColor3 = Color3.fromRGB(255, 255, 255)
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 12)
    UICorner.Parent = Button
    
    local UIStroke = Instance.new("UIStroke")
    UIStroke.Parent = Button
    UIStroke.Color = Color3.fromRGB(0, 255, 255) -- Viền xanh cyan cho dễ thấy
    UIStroke.Thickness = 2
    UIStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    
    -- Draggable (Kéo thả mượt mà)
    local dragging, dragInput, dragStart, startPos
    Button.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = Button.Position
            
            -- Hiệu ứng nhấn
            TweenService:Create(Button, TweenInfo.new(0.1), {Size = UDim2.new(0, 40, 0, 40)}):Play()
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    -- Hiệu ứng nhả
                    TweenService:Create(Button, TweenInfo.new(0.1), {Size = UDim2.new(0, 45, 0, 45)}):Play()
                end
            end)
        end
    end)
    
    Button.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            Button.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    -- [FIX] Toggle Logic: Direct Find & Switch
    Button.MouseButton1Click:Connect(function()
        -- Cách 1: Thử tìm GUI của Fluent trong CoreGui và tắt/bật nó
        local found = false
        for _, v in pairs(CoreGui:GetChildren()) do
            -- Fluent thường tạo ScreenGui không tên hoặc tên ngẫu nhiên, nhưng chứa Frame chính
            -- Ta lọc các GUI không phải của mình (KeroToggleUI)
            if v:IsA("ScreenGui") and v.Name ~= "KeroToggleUI" and v ~= ScreenGui then
                -- Kiểm tra dấu hiệu của Fluent (thường có Frame to chứa Tab)
                local mainFrame = v:FindFirstChild("Frame") or v:FindFirstChild("Main") or v:FindFirstChild("Window")
                if mainFrame and v.Enabled ~= nil then
                    v.Enabled = not v.Enabled -- Đảo trạng thái Bật/Tắt
                    found = true
                    -- Không break vì lỡ có nhiều layer
                end
            end
        end
        
        -- Cách 2: Nếu Cách 1 không tìm thấy, dùng phím ảo (Fallback)
        if not found then
            pcall(function()
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.RightControl, false, game)
                task.wait()
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.RightControl, false, game)
            end)
        end
    end)
end

CreateToggleButton()

-- =============================================
-- CONFIGURATION
-- =============================================
local RETRY_X = 650
local RETRY_Y = 468
local MACRO_FOLDER = "AWTD_Macros_Kero"
local CALC_DELAY = 0.5 

-- =============================================
-- VARIABLES
-- =============================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local isRecording = false
local isPlaying = false
local isLooping = false 
local currentMacroData = {} 
local currentMacroName = "" 
local startTime = 0
local playbackMode = "Hybrid" 

local AllowedRemotes = {
    ["SpawnUnit"] = true, ["SellUnit"] = true, ["UpgradeUnit"] = true,
    ["UnitAbility"] = true, ["BuyMeat"] = true, ["FeedAll"] = true,
    ["SkipEvent"] = true, ["x2Event"] = true
}

if not isfolder(MACRO_FOLDER) then makefolder(MACRO_FOLDER) end

-- =============================================
-- HELPER FUNCTIONS
-- =============================================
local function SmartFire(remote, args)
    if not remote then return end
    args = args or {}
    if remote:IsA("RemoteEvent") or remote:IsA("UnreliableRemoteEvent") then
        remote:FireServer(unpack(args))
    elseif remote:IsA("RemoteFunction") then
        task.spawn(function() pcall(function() remote:InvokeServer(unpack(args)) end) end)
    end
end

local function CFrameToTable(cf) return {cf:GetComponents()} end
local function TableToCFrame(tab) return CFrame.new(unpack(tab)) end

local function getCash()
    local ls = LocalPlayer:FindFirstChild("leaderstats")
    return (ls and ls:FindFirstChild("Cash")) and ls.Cash.Value or 0
end

local function findUnitByCFrame(targetCFrame)
    if not Workspace:FindFirstChild("Units") then return nil end
    for _, unit in pairs(Workspace.Units:GetChildren()) do
        local root = unit:FindFirstChild("HumanoidRootPart") or unit.PrimaryPart
        if root and (root.Position - targetCFrame.Position).Magnitude < 1.5 then return unit end
    end
    return nil
end

-- =============================================
-- FILE SYSTEM
-- =============================================
local function SaveCurrentMacro()
    if currentMacroName == "" then return end
    local exportData = {}
    for _, act in ipairs(currentMacroData) do
        local entry = table.clone(act)
        if entry.CFrame then entry.CFrame = CFrameToTable(entry.CFrame) end
        table.insert(exportData, entry)
    end
    writefile(MACRO_FOLDER.."/"..currentMacroName..".json", HttpService:JSONEncode(exportData))
    Fluent:Notify({Title="System", Content="Saved: "..currentMacroName, Duration=2})
end

local function LoadMacro(name)
    if not isfile(MACRO_FOLDER.."/"..name..".json") then return end
    local content = readfile(MACRO_FOLDER.."/"..name..".json")
    local decoded = HttpService:JSONDecode(content)
    currentMacroData = {}
    for _, act in ipairs(decoded) do
        if act.CFrame then act.CFrame = TableToCFrame(act.CFrame) end
        table.insert(currentMacroData, act)
    end
    currentMacroName = name
end

local function GetMacroFiles()
    local files = listfiles(MACRO_FOLDER)
    local names = {}
    for _, file in ipairs(files) do
        local name = file:match("([^/]+)%.json$")
        if name then table.insert(names, name) end
    end
    return names
end

-- =============================================
-- RECORDER (SAFE)
-- =============================================
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    if checkcaller() then return oldNamecall(self, ...) end
    if not isRecording then return oldNamecall(self, ...) end
    
    local method = getnamecallmethod()
    if (method == "InvokeServer" or method == "FireServer") and AllowedRemotes[self.Name] then
        local rName = self.Name
        local args = {...}
        task.spawn(function()
            pcall(function()
                local currentTime = tick() - startTime
                local preCash = getCash()

                if rName == "SpawnUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    table.insert(currentMacroData, {Action="Place", Time=currentTime, Cost=realCost, UnitName=args[1], CFrame=args[2], Slot=args[3], Data=args[4]})
                    Fluent:Notify({Title="Rec", Content="Place", Duration=1})
                elseif rName == "SellUnit" then
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Sell", Time=currentTime, Cost=0, CFrame=u.PrimaryPart.CFrame}); Fluent:Notify({Title="Rec", Content="Sell", Duration=1}) end
                elseif rName == "UpgradeUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Upgrade", Time=currentTime, Cost=realCost, CFrame=u.PrimaryPart.CFrame}); Fluent:Notify({Title="Rec", Content="Upgrade", Duration=1}) end
                elseif rName == "UnitAbility" then
                     local u = args[2]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Ability", Time=currentTime, Cost=0, SkillName=args[1], CFrame=u.PrimaryPart.CFrame}) end
                elseif rName == "BuyMeat" then 
                    task.wait(CALC_DELAY)
                    table.insert(currentMacroData, {Action="BuyMeat", Time=currentTime, Cost=math.max(0, preCash - getCash()), Args=args})
                    Fluent:Notify({Title="Rec", Content="Buy Meat", Duration=1})
                elseif rName == "FeedAll" then table.insert(currentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- UI SETUP
-- =============================================
local Tabs = {
    Macro = Window:AddTab({ Title = "Macro Manager", Icon = "file-cog" }),
    Lobby = Window:AddTab({ Title = "Lobby Manager", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}
local Options = Fluent.Options
local StatusParagraph = Tabs.Macro:AddParagraph({ Title = "Status: Idle", Content = "Waiting..." })

local function UpdateStatus(status, details)
    StatusParagraph:SetTitle("Status: " .. status)
    StatusParagraph:SetDesc(details or "")
end

-- TAB: MACRO MANAGER
Tabs.Macro:AddInput("InputMacroName", {Title = "New Macro Name", Placeholder = "MapName_Diff", Callback = function() end})
Tabs.Macro:AddButton({Title = "Create New File", Callback = function() local name = Options.InputMacroName.Value; if name~="" then currentMacroName=name; currentMacroData={}; SaveCurrentMacro(); Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(name) end end})
Tabs.Macro:AddDropdown("FileSelect", {Title = "Select File", Values = GetMacroFiles(), Default = 1, Callback = function(v) if v then LoadMacro(v) end end})
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); Options.FileSelect:SetValue(f[1]) end end)
Tabs.Macro:AddButton({Title = "Refresh / Delete", Callback = function() if currentMacroName~="" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then delfile(MACRO_FOLDER.."/"..currentMacroName..".json"); currentMacroName=""; currentMacroData={}; Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(nil) else Options.FileSelect:SetValues(GetMacroFiles()) end end})

-- [SAFETY FIX] Đảm bảo tắt Playback khi bật Record
Tabs.Macro:AddToggle("RecordToggle", {Title = "Record", Default = false }):OnChanged(function(v)
    if v then 
        isPlaying = false -- Kill Playback Loop
        Options.PlayToggle:SetValue(false) -- Force UI Toggle OFF
        isRecording = true
        currentMacroData = {} 
        startTime = tick() 
        UpdateStatus("Recording", "Started...")
    else 
        isRecording = false
        SaveCurrentMacro()
        UpdateStatus("Stopped", "Saved.") 
    end
end)

Tabs.Macro:AddDropdown("ModeSelect", {Title = "Mode", Values = {"Time", "Money", "Hybrid"}, Default = "Hybrid", Callback = function(v) playbackMode = v end})

-- [SAFETY FIX] Đảm bảo tắt Record khi bật Playback
Tabs.Macro:AddToggle("PlayToggle", {Title = "Play", Default = false }):OnChanged(function(v)
    if v then 
        isRecording = false -- Kill Record
        Options.RecordToggle:SetValue(false) -- Force UI Toggle OFF
        playMacro() 
    else 
        isPlaying = false
        UpdateStatus("Stopped", "User Cancelled") 
    end
end)

-- TAB: LOBBY MANAGER
local LoopToggle = Tabs.Lobby:AddToggle("LoopToggle", {Title = "Auto Restart (Loop)", Default = false })
LoopToggle:OnChanged(function(v) isLooping = v end)

-- TAB: SETTINGS & AUTO SAVE
SaveManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
SaveManager:BuildConfigSection(Tabs.Settings)

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()

-- =============================================
-- LOGIC
-- =============================================
local function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

local function PerformRestartSequence()
    UpdateStatus("Looping", "Effect Found! Waiting 2s...")
    task.wait(2)
    UpdateStatus("Looping", "Clicking Retry ("..RETRY_X..", "..RETRY_Y..")...")
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, true, game, 1)
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, false, game, 1)
    UpdateStatus("Looping", "Clicked. Waiting 5s for reload...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                -- Double Check Safety
                if isRecording then isPlaying = false; break end

                if isLooping and CheckForEndGame() then matchEnded = true; break end
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = true
                    if playbackMode ~= "Time" and cost > 0 then readyM = cash >= cost end
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         elseif not readyM then UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; Options.PlayToggle:SetValue(false); UpdateStatus("Stopped", "Finished Run"); break end
            end
        end
    end)
end
rrentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- UI SETUP
-- =============================================
local Tabs = {
    Macro = Window:AddTab({ Title = "Macro Manager", Icon = "file-cog" }),
    Lobby = Window:AddTab({ Title = "Lobby Manager", Icon = "home" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}
local Options = Fluent.Options
local StatusParagraph = Tabs.Macro:AddParagraph({ Title = "Status: Idle", Content = "Waiting..." })

local function UpdateStatus(status, details)
    StatusParagraph:SetTitle("Status: " .. status)
    StatusParagraph:SetDesc(details or "")
end

-- TAB: MACRO MANAGER
Tabs.Macro:AddInput("InputMacroName", {Title = "New Macro Name", Placeholder = "MapName_Diff", Callback = function() end})
Tabs.Macro:AddButton({Title = "Create New File", Callback = function() local name = Options.InputMacroName.Value; if name~="" then currentMacroName=name; currentMacroData={}; SaveCurrentMacro(); Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(name) end end})
Tabs.Macro:AddDropdown("FileSelect", {Title = "Select File", Values = GetMacroFiles(), Default = 1, Callback = function(v) if v then LoadMacro(v) end end})
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); Options.FileSelect:SetValue(f[1]) end end)
Tabs.Macro:AddButton({Title = "Refresh / Delete", Callback = function() if currentMacroName~="" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then delfile(MACRO_FOLDER.."/"..currentMacroName..".json"); currentMacroName=""; currentMacroData={}; Options.FileSelect:SetValues(GetMacroFiles()); Options.FileSelect:SetValue(nil) else Options.FileSelect:SetValues(GetMacroFiles()) end end})

-- [SAFETY FIX] Đảm bảo tắt Playback khi bật Record
Tabs.Macro:AddToggle("RecordToggle", {Title = "Record", Default = false }):OnChanged(function(v)
    if v then 
        isPlaying = false -- Kill Playback Loop
        Options.PlayToggle:SetValue(false) -- Force UI Toggle OFF
        isRecording = true
        currentMacroData = {} 
        startTime = tick() 
        UpdateStatus("Recording", "Started...")
    else 
        isRecording = false
        SaveCurrentMacro()
        UpdateStatus("Stopped", "Saved.") 
    end
end)

Tabs.Macro:AddDropdown("ModeSelect", {Title = "Mode", Values = {"Time", "Money", "Hybrid"}, Default = "Hybrid", Callback = function(v) playbackMode = v end})

-- [SAFETY FIX] Đảm bảo tắt Record khi bật Playback
Tabs.Macro:AddToggle("PlayToggle", {Title = "Play", Default = false }):OnChanged(function(v)
    if v then 
        isRecording = false -- Kill Record
        Options.RecordToggle:SetValue(false) -- Force UI Toggle OFF
        playMacro() 
    else 
        isPlaying = false
        UpdateStatus("Stopped", "User Cancelled") 
    end
end)

-- TAB: LOBBY MANAGER
local LoopToggle = Tabs.Lobby:AddToggle("LoopToggle", {Title = "Auto Restart (Loop)", Default = false })
LoopToggle:OnChanged(function(v) isLooping = v end)

-- TAB: SETTINGS & AUTO SAVE
SaveManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
SaveManager:BuildConfigSection(Tabs.Settings)

InterfaceManager:SetLibrary(Fluent)
InterfaceManager:BuildInterfaceSection(Tabs.Settings)

Window:SelectTab(1)
SaveManager:LoadAutoloadConfig()

-- =============================================
-- LOGIC
-- =============================================
local function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

local function PerformRestartSequence()
    UpdateStatus("Looping", "Effect Found! Waiting 2s...")
    task.wait(2)
    UpdateStatus("Looping", "Clicking Retry ("..RETRY_X..", "..RETRY_Y..")...")
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, true, game, 1)
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(RETRY_X, RETRY_Y, 0, false, game, 1)
    UpdateStatus("Looping", "Clicked. Waiting 5s for reload...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                -- Double Check Safety
                if isRecording then isPlaying = false; break end

                if isLooping and CheckForEndGame() then matchEnded = true; break end
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = true
                    if playbackMode ~= "Time" and cost > 0 then readyM = cash >= cost end
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         elseif not readyM then UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; Options.PlayToggle:SetValue(false); UpdateStatus("Stopped", "Finished Run"); break end
            end
        end
    end)
end

