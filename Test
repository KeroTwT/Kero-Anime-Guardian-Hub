-- [V42] AWTD Macro | Fix Crash Line 1 | Delta Support
local LibraryURL = "https://raw.githubusercontent.com/vep1032/MacLib/main/source.lua"

local success, MacLib = pcall(function()
    return loadstring(game:HttpGet(LibraryURL))()
end)

if not success or not MacLib then
    warn("Link 1 loi, dang thu Link du phong...")
    -- Link dự phòng nếu link trên chết
    success, MacLib = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/MacLib/main/source.lua"))()
    end)
end

if not success or not MacLib then
    game.StarterGui:SetCore("SendNotification", {
        Title = "Lỗi Script";
        Text = "Không tải được UI Library! Kiểm tra mạng.";
        Duration = 5;
    })
    return -- Dừng script nếu không có UI
end

local Window = MacLib:Window({
    Title = "AWTD Macro (Delta Fix)",
    Subtitle = "Smart Restart",
    Size = UDim2.fromOffset(550, 400),
    DragStyle = 1,
    Theme = "Dark"
})

-- =============================================
-- SERVICES
-- =============================================
local HttpService = game:GetService("HttpService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local GuiService = game:GetService("GuiService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- =============================================
-- CONFIG
-- =============================================
local MACRO_FOLDER = "AWTD_Macros_Kero"
local CALC_DELAY = 0.5 

-- =============================================
-- VARIABLES
-- =============================================
local isRecording = false
local isPlaying = false
local isLooping = false 
local currentMacroData = {} 
local currentMacroName = "" 
local inputMacroNameVal = "" 
local startTime = 0
local playbackMode = "Hybrid" 

local AllowedRemotes = {
    ["SpawnUnit"] = true, ["SellUnit"] = true, ["UpgradeUnit"] = true,
    ["UnitAbility"] = true, ["BuyMeat"] = true, ["FeedAll"] = true,
    ["SkipEvent"] = true, ["x2Event"] = true
}

if not isfolder(MACRO_FOLDER) then makefolder(MACRO_FOLDER) end

-- =============================================
-- UI TABS
-- =============================================
local TabMacro = Window:Tab("Macro Manager")
local TabLobby = Window:Tab("Lobby Manager")

local GroupFile = TabMacro:Group("File System")
local GroupRec = TabMacro:Group("Recorder & Player")
local GroupInfo = TabMacro:Group("Status")
local GroupLobby = TabLobby:Group("Auto Restart")

-- =============================================
-- HELPERS
-- =============================================
local function Notify(title, content)
    Window:Notify({ Title = title, Description = content, Lifetime = 3 })
end

local function SmartFire(remote, args)
    if not remote then return end
    args = args or {}
    if remote:IsA("RemoteEvent") or remote:IsA("UnreliableRemoteEvent") then
        remote:FireServer(unpack(args))
    elseif remote:IsA("RemoteFunction") then
        task.spawn(function() pcall(function() remote:InvokeServer(unpack(args)) end) end)
    end
end

local function CFrameToTable(cf) return {cf:GetComponents()} end
local function TableToCFrame(tab) return CFrame.new(unpack(tab)) end

local function getCash()
    local ls = LocalPlayer:FindFirstChild("leaderstats")
    return (ls and ls:FindFirstChild("Cash")) and ls.Cash.Value or 0
end

local function findUnitByCFrame(targetCFrame)
    if not Workspace:FindFirstChild("Units") then return nil end
    for _, unit in pairs(Workspace.Units:GetChildren()) do
        local root = unit:FindFirstChild("HumanoidRootPart") or unit.PrimaryPart
        if root and (root.Position - targetCFrame.Position).Magnitude < 1.5 then return unit end
    end
    return nil
end

local function GetMacroFiles()
    local files = listfiles(MACRO_FOLDER)
    local names = {}
    for _, file in ipairs(files) do
        local name = file:match("([^/]+)%.json$")
        if name then table.insert(names, name) end
    end
    return names
end

-- =============================================
-- UI COMPONENTS
-- =============================================
local StatusLabel = GroupInfo:Label("Status: Idle")

local function UpdateStatus(status, details)
    StatusLabel:SetText("Status: " .. status .. " [" .. (details or "") .. "]")
end

GroupFile:Input("New Macro Name", {
    Default = "",
    Placeholder = "MapName_Diff",
    Callback = function(v) inputMacroNameVal = v end
})

local function SaveCurrentMacro()
    if currentMacroName == "" then return end
    local exportData = {}
    for _, act in ipairs(currentMacroData) do
        local entry = table.clone(act)
        if entry.CFrame then entry.CFrame = CFrameToTable(entry.CFrame) end
        table.insert(exportData, entry)
    end
    writefile(MACRO_FOLDER.."/"..currentMacroName..".json", HttpService:JSONEncode(exportData))
    Notify("System", "Saved: "..currentMacroName)
end

local function LoadMacro(name)
    if not isfile(MACRO_FOLDER.."/"..name..".json") then return end
    local content = readfile(MACRO_FOLDER.."/"..name..".json")
    local decoded = HttpService:JSONDecode(content)
    currentMacroData = {}
    for _, act in ipairs(decoded) do
        if act.CFrame then act.CFrame = TableToCFrame(act.CFrame) end
        table.insert(currentMacroData, act)
    end
    currentMacroName = name
    Notify("System", "Loaded: "..name)
end

local FileDropdown = GroupFile:Dropdown("Select File", {
    Options = GetMacroFiles(),
    Default = "...",
    Callback = function(v) if v then LoadMacro(v) end end
})

GroupFile:Button("Create New File", function()
    local name = inputMacroNameVal
    if name ~= "" then
        currentMacroName = name
        currentMacroData = {}
        SaveCurrentMacro()
        FileDropdown:SetOptions(GetMacroFiles())
        Notify("System", "Created: " .. name)
    else
        Notify("Error", "Enter a name first!")
    end
end)

GroupFile:Button("Refresh / Delete Selected", function()
    if currentMacroName ~= "" and isfile(MACRO_FOLDER.."/"..currentMacroName..".json") then
        delfile(MACRO_FOLDER.."/"..currentMacroName..".json")
        Notify("System", "Deleted: " .. currentMacroName)
        currentMacroName = ""
        currentMacroData = {}
        FileDropdown:SetOptions(GetMacroFiles())
    else
        FileDropdown:SetOptions(GetMacroFiles())
        Notify("System", "Refreshed List")
    end
end)

GroupRec:Dropdown("Mode", {
    Options = {"Time", "Money", "Hybrid"},
    Default = "Hybrid",
    Callback = function(v) playbackMode = v end
})

local RecordToggle = GroupRec:Toggle("Record", {
    Default = false,
    Callback = function(v)
        if v then 
            isPlaying = false; isRecording = true; currentMacroData = {}; startTime = tick()
            UpdateStatus("Recording", "Started...")
        else 
            isRecording = false; SaveCurrentMacro()
            UpdateStatus("Stopped", "Saved.")
        end
    end
})

local PlayToggle = GroupRec:Toggle("Play", {
    Default = false,
    Callback = function(v)
        if v then
            isRecording = false
            task.spawn(function() playMacro() end)
        else
            isPlaying = false
            UpdateStatus("Stopped", "User Cancelled")
        end
    end
})

GroupLobby:Toggle("Auto Restart (Loop)", {
    Default = false,
    Callback = function(v) isLooping = v end
})

-- =============================================
-- RECORDER LOGIC
-- =============================================
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    if checkcaller() then return oldNamecall(self, ...) end
    if not isRecording then return oldNamecall(self, ...) end
    
    local method = getnamecallmethod()
    if (method == "InvokeServer" or method == "FireServer") and AllowedRemotes[self.Name] then
        local rName = self.Name
        local args = {...}
        task.spawn(function()
            pcall(function()
                local currentTime = tick() - startTime
                local preCash = getCash()
                if rName == "SpawnUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    table.insert(currentMacroData, {Action="Place", Time=currentTime, Cost=realCost, UnitName=args[1], CFrame=args[2], Slot=args[3], Data=args[4]})
                    Notify("Rec", "Place Unit")
                elseif rName == "SellUnit" then
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Sell", Time=currentTime, Cost=0, CFrame=u.PrimaryPart.CFrame}); Notify("Rec", "Sell Unit") end
                elseif rName == "UpgradeUnit" then
                    task.wait(CALC_DELAY)
                    local realCost = math.max(0, preCash - getCash())
                    local u = args[1]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Upgrade", Time=currentTime, Cost=realCost, CFrame=u.PrimaryPart.CFrame}); Notify("Rec", "Upgrade") end
                elseif rName == "UnitAbility" then
                     local u = args[2]; if u and u.PrimaryPart then table.insert(currentMacroData, {Action="Ability", Time=currentTime, Cost=0, SkillName=args[1], CFrame=u.PrimaryPart.CFrame}) end
                elseif rName == "BuyMeat" then 
                    task.wait(CALC_DELAY)
                    table.insert(currentMacroData, {Action="BuyMeat", Time=currentTime, Cost=math.max(0, preCash - getCash()), Args=args}); Notify("Rec", "Buy Meat")
                elseif rName == "FeedAll" then table.insert(currentMacroData, {Action="FeedAll", Time=currentTime, Cost=0})
                elseif rName == "SkipEvent" then table.insert(currentMacroData, {Action="SkipWave", Time=currentTime, Cost=0})
                elseif rName == "x2Event" then table.insert(currentMacroData, {Action="AutoSpeed", Time=currentTime, Cost=0})
                end
            end)
        end)
    end
    return oldNamecall(self, ...)
end)
setreadonly(mt, true)

-- =============================================
-- PLAY & RESTART LOGIC
-- =============================================
local function CheckForEndGame()
    local Effects = Workspace:FindFirstChild("Effect")
    if Effects then
        for _, v in pairs(Effects:GetChildren()) do
            if string.find(v.Name:lower(), "gameover") or string.find(v.Name:lower(), "victory") then return true end
        end
    end
    return false
end

local function PerformRestartSequence()
    UpdateStatus("Looping", "End Game Detected...")
    
    local function firebutton()
        local success, Button = pcall(function()
            return LocalPlayer.PlayerGui.EndUI.UI.Stage_Grid.Frame.Restart.Button
        end)
        
        -- Nếu không tìm thấy, thử tìm theo cách khác phòng khi UI game thay đổi
        if not success or not Button then 
            -- Fallback: Thử tìm trong PlayerGui chung chung
            local found = false
            for _, v in pairs(LocalPlayer.PlayerGui:GetDescendants()) do
                if v.Name == "Button" and v.Parent and v.Parent.Name == "Restart" then
                    Button = v
                    found = true
                    break
                end
            end
            if not found then return end
        end

        GuiService.GuiNavigationEnabled = true
        GuiService.SelectedObject = Button
        VirtualInputManager:SendKeyEvent(true, "Return", false, game)
        VirtualInputManager:SendKeyEvent(false, "Return", false, game)
        task.wait(0.05)
        GuiService.GuiNavigationEnabled = false
        GuiService.SelectedObject = nil
    end

    -- Loop click until Effect disappears (Game Restarted)
    local retries = 0
    while CheckForEndGame() do
        retries = retries + 1
        if retries > 60 then -- An toàn: Nếu kẹt quá 60s thì force reload
            UpdateStatus("Looping", "Stuck! Rejoining...")
            game:GetService("TeleportService"):TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
            break 
        end
        UpdateStatus("Looping", "Clicking Retry ("..retries..")...")
        firebutton()
        task.wait(1)
    end

    UpdateStatus("Looping", "Restarting...")
    task.wait(5)
    return true
end

function playMacro()
    if #currentMacroData == 0 then Notify("Manager", "No Data!"); PlayToggle:Set(false); return end
    isPlaying = true
    task.spawn(function()
        while isPlaying do
            UpdateStatus("Starting...", "Match Start")
            local startT = tick()
            local step = 1
            local matchEnded = false
            local Remotes = ReplicatedStorage:WaitForChild("Remote")
            local R = {
                Spawn=Remotes:FindFirstChild("SpawnUnit"), Sell=Remotes:FindFirstChild("SellUnit"),
                Upgrade=Remotes:FindFirstChild("UpgradeUnit"), Ability=Remotes:FindFirstChild("UnitAbility"),
                BuyMeat=Remotes:FindFirstChild("BuyMeat"), FeedAll=Remotes:FindFirstChild("FeedAll"),
                Skip=Remotes:FindFirstChild("SkipEvent"), Speed=Remotes:FindFirstChild("x2Event")
            }

            while isPlaying do
                if isLooping and CheckForEndGame() then matchEnded = true; break end
                
                if step <= #currentMacroData then
                    local act = currentMacroData[step]
                    local passed = tick() - startT
                    local cash = getCash()
                    local cost = act.Cost or 0
                    local readyT = passed >= act.Time
                    local readyM = (playbackMode == "Time") or (cash >= cost)
                    
                    if (playbackMode == "Time" and readyT) or (playbackMode == "Money" and readyM) or (readyT and readyM) then
                        UpdateStatus("Playing", "Step: "..step.." | "..act.Action)
                        if act.Action == "Place" and R.Spawn then SmartFire(R.Spawn, {act.UnitName, act.CFrame, act.Slot, act.Data})
                        elseif act.Action == "Upgrade" and R.Upgrade then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Upgrade, {u}) end
                        elseif act.Action == "Sell" and R.Sell then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Sell, {u}) end
                        elseif act.Action == "Ability" and R.Ability then local u = findUnitByCFrame(act.CFrame); if u then SmartFire(R.Ability, {act.SkillName, u}) end
                        elseif act.Action == "BuyMeat" and R.BuyMeat then SmartFire(R.BuyMeat, act.Args or {}) 
                        elseif act.Action == "FeedAll" and R.FeedAll then SmartFire(R.FeedAll, {})
                        elseif act.Action == "SkipWave" and R.Skip then SmartFire(R.Skip, {})
                        elseif act.Action == "AutoSpeed" and R.Speed then SmartFire(R.Speed, {})
                        end
                        step = step + 1
                    else
                         if not readyT then UpdateStatus("Waiting", string.format("Time: %.1fs", act.Time - passed))
                         else UpdateStatus("Waiting", "Cash: "..cash.."/"..cost) end
                    end
                else
                    UpdateStatus("Idle", "Macro Done. Waiting for End...")
                end
                task.wait(0.1)
                if not isPlaying then break end
            end
            
            if isPlaying then
                if isLooping and matchEnded then PerformRestartSequence()
                elseif not isLooping then isPlaying = false; PlayToggle:Set(false); UpdateStatus("Stopped", "Finished"); break end
            end
        end
    end)
end

-- Init
task.delay(1, function() local f=GetMacroFiles(); if #f>0 then LoadMacro(f[1]); FileDropdown:SetOptions(f) end end)
